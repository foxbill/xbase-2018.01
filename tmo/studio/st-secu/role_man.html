<html>
<head>
    <title>角色管理</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script type="text/javascript" src="../../xbase.js/utils/net_util.js"></script>

    <script type="text/javascript" src="../../xbase.js/system/system.js"></script>

    <script type="text/javascript" src="../../xbase.js/system/wjs.js"></script>

    <script type="text/jscript" src="../../xbase.js/controls/xlistview.js"></script>

    <script type="text/jscript" src="../../xbase.js/controls/tab_control.js"></script>

    <script type="text/javascript">
        var gRoleList;
        var gTabPage;
        var gObjTypeList;
        var gPermissionList;

        window.onload = function() {
            if (!gRoleList) {
                gRoleList = new ListView(elRoleList, elRoleItem, elRoleListHead);
                gRoleList.activeItemCss = "activeItem";
            }
            getRoleList();

            gTabPage = new TabControl([divTagRoleList, divTagRoleInfo, divTagRolePermission], [divPageRoleList, divPageRoleInfo, divPageRolePermission], "onclick", "TabTag Act");
            gTabPage.onTabActive = onTabActive;

            gObjTypeList = new ListView(elPermissionTypeList, elPermissionTypeItem, elPermissionTypeListHead);
            gObjTypeList.activeItemCss = "Label ActiveLabel";
            getPermessionTypeList();
            gObjTypeList.setActiveIndex(0);

            gPermissionList = new ListView(elPermissionList, elPermissionItem, elPermissionListHead);
            gPermissionList.activeItemCss = "activeItem";
        }

        function getPermessionTypeList() {
            var req = new JoapRequest("WboAdmin", "", "GetObjectTypes");
            var types = req.invoke();

            gObjTypeList.clear();
            if (!types) return;

            for (var i = 0; i < types.length; i++) {
                var item = types[i];
                var listItem = gObjTypeList.addItem();
                listItem.data = item;

                if (!item.Title)
                    item.Title = item.Id;
                gObjTypeList.setItemValue(listItem, "ObjectTypeId", item.Id);
                gObjTypeList.setItemValue(listItem, "ObjectTypeTitle", item.Title + "权限");
            }
        }

        function getRoleList() {
            var req = new JoapRequest("RoleManager", "", "GetRoles");
            var roles = req.invoke();


            gRoleList.clear();
            if (!roles) return;

            for (var i = 0; i < roles.length; i++) {
                var role = roles[i];
                var listItem = gRoleList.addItem();
                listItem.data = role;
                if (!role.DisplayName)
                    role.DisplayName = role.Id;
                gRoleList.setItemValue(listItem, "RoleId", role.Id);
                gRoleList.setItemValue(listItem, "DisplayName", role.DisplayName);
                gRoleList.setItemValue(listItem, "Remark", role.Remark);
            }
        }


        function getRolePermissions() {

            var roleId = gRoleList.getValue("RoleId");

            if (!roleId) {
                alert("请选择一个角色");
                gTabPage.SelectTab(divTagRoleList);
                return
            }

            var objType = gObjTypeList.getValue("ObjectTypeId");
            objType = !objType ? "" : objType;

            var req = new JoapRequest("RoleManager", "", "GetRolePermissions");
            req.addParamate("roleId", roleId);
            req.addParamate("objType", objType);

            var permis = req.invoke();


            gPermissionList.clear();
            if (!permis) return;

            for (var i = 0; i < permis.length; i++) {
                var perm = permis[i];
                var listItem = gPermissionList.addItem();
                var captions = perm.PermissionCaptions;
                var objPerms = perm.PermissionList;

                listItem.data = perm;
                if (!perm.DisplayName)
                    perm.DisplayName = perm.Id;
                gPermissionList.setItemValue(listItem, "PermissionObjectType", perm.ObjectType);
                gPermissionList.setItemValue(listItem, "PermissionObjectName", perm.ObjectId);

                var permElement = gPermissionList.getItemElement(listItem, "Permission");

                var html = "";
                for (var perName in objPerms) {
                    var checked = objPerms[perName] == true ? "checked" : "";
                    html += captions[perName] + "<input  type='checkbox' " + checked + " name='" + perName + "'   />&nbsp;&nbsp;";
                }

                permElement.innerHTML = html;

                //gPermissionList.setItemValue(listItem, "Permission", perm.Remark);

            }
        }

        function setRole(role) {
            role.Id = elRoleId.value;
            role.DisplayName = elDisplayName.value;
            role.Remark = elRemark.value;

            return true;
        }

        function getRole(role) {
            elRoleId.value = role.Id;
            elDisplayName.value = role.DisplayName;
            elRemark.value = role.Remark;
            elOldRoleId.value = role.Id;
        }

        function onNewRoleClick() {
            gTabPage.selectTab(divTagRoleInfo);
            newRole();
        }

        function newRole() {
            var role = new Object();
            role.Id = "";
            role.DisplayName = "";
            role.Remark = "";
            elOldRoleId.value = "";
            getRole(role);
            return role;
        }

        function saveRole() {

            var tab = gTabPage.getActiveTab();
            if (tab != divTagRoleInfo) {
                alert("没有角色被编辑，请选择新建角色，或编辑角色");
                return;
            }

            var role = new Object();
            setRole(role);

            var gRoleReq = new JoapRequest("RoleManager", "", "SaveRole");
            gRoleReq.addParamate("role", role);
            gRoleReq.addParamate("roleId", elOldRoleId.value);

            var ret = gRoleReq.invoke();

            if (ret) {
                elOldRoleId.value = role.Id;
                alert("角色保存完成!");
            }
            getRoleList();
        }

        function deleteRolebyId(roleId) {

            var gRoleReq = new JoapRequest("RoleManager", "", "DeleteRole");
            gRoleReq.addParamate("roleId", roleId);

            var ret = gRoleReq.invoke();
            if (ret)
                alert("角色：" + roleId + "被删除");
        }

        function onTabActive(tab) {

            if (tab == divTagRoleInfo) {
                var item = gRoleList.getActiveItem();
                var role;
                if (item)
                    role = item.data;
                else
                    role = newRole();
                getRole(role);
            } else if (tab == divTagRolePermission) {
                getRolePermissions();
            }

        }


        function listEditRole_onclick(sender) {
            var item = gRoleList.getItemByElement(sender);
            gRoleList.setActiveItem(item);
            gTabPage.selectTab(divTagRoleInfo);
        }

        function listDeleteRole_onclick(sender) {
            var item = gRoleList.getItemByElement(sender);
            var roleId = gRoleList.getItemValue(item, "RoleId");
            var displayName = gRoleList.getItemValue(item, "DisplayName");
            if (!confirm("是否要删除角色：'" + displayName + "(" + roleId + ")'?")) return;
            deleteRolebyId(roleId);
            getRoleList();
        }


        function onObjTypeClick(sender) {
            var item = gObjTypeList.getItemByElement(sender);
            gObjTypeList.setActiveItem(item);
            getRolePermissions();
        }

        function addPermission() {

            if (!gRoleList.getActiveItem()) {
                alert("请选择一个角色");
                return;
            }

            var ret = window.showModalDialog("../comm/wbo_list.htm", null, "dialogWidth=800px;dialogHeight=600px");
            if (!ret) return;

            var typeItem = gObjTypeList.getItemByField("ObjectTypeId", ret.objType);
            gObjTypeList.setActiveItem(typeItem);
            gTabPage.SelectTab(divTagRolePermission);
            //            getRolePermissions();        


            var req = new JoapRequest("RoleManager", "", "GetPermissionCaptions");
            var pCaptions = req.invoke();



            for (var i = 0; i < ret.objList.length; i++) {
                var obj = ret.objList[i];
                var item = gPermissionList.addItem();

                gPermissionList.setItemValue(item, "PermissionObjectType", ret.objType);
                gPermissionList.setItemValue(item, "PermissionObjectName", obj.objId);

                var permElement = gPermissionList.getItemElement(item, "Permission");

                var html = "";
                for (var perName in pCaptions) {
                    html += pCaptions[perName] + "<input  type='checkbox'value='0' name='" + perName + "'   />&nbsp;&nbsp;";
                }

                permElement.innerHTML = html;

            }

        }

        function savePermission() {

            if (gTabPage.getActiveTab() != divTagRolePermission) {
                alert("权限不在权限编辑状态，请选择角色权限，或添加权限");
                return;
            }

            var roleId = gRoleList.getValue("RoleId");

            if (!roleId) {
                alert("没有角色被选中，不能保存权限");
                return;
            }

            var perObjList = [];

            var lists = gPermissionList.items;
            if (!lists.length)
                return;

            for (var i = 0; i < lists.length; i++) {
                var lstItem = lists[i];
                var po = new Object;
                po.ObjectType = gPermissionList.getItemValue(lstItem, "PermissionObjectType");
                po.ObjectId = gPermissionList.getItemValue(lstItem, "PermissionObjectName");

                po.PermissionList = new Object();
                var permElement = gPermissionList.getItemElement(lstItem, "Permission");
                var pChecks = permElement.getElementsByTagName("input");
                for (var j = 0; j < pChecks.length; j++) {
                    var chk = pChecks[j];
                    if (chk.checked)
                        po.PermissionList[chk.name]=true;
                }
                perObjList.push(po);
            }
            var rolePermisssions = new Object();
            rolePermisssions.RoleId = roleId;
            rolePermisssions.PermissionObjList = perObjList;
            var req = new JoapRequest("RoleManager", "", "SavePermissions");
            req.addParamate("rolePermisssions", rolePermisssions);

            if (req.invoke()) {
                alert("权限已经被保存！");
            };
        }
        function listDeletePermission_onclick(sender) {

            var roleId = gRoleList.getValue("RoleId");

            if (!roleId) {
                alert("没有角色被选中，不能保存权限");
                return;
            }


            var lstItem = gPermissionList.getItemByElement(sender);

            var objectType = gPermissionList.getItemValue(lstItem, "PermissionObjectType");
            var objectId = gPermissionList.getItemValue(lstItem, "PermissionObjectName");
            var req = new JoapRequest("RoleManager", "", "DeletePermission");
            req.addParamate("roleId", roleId);
            req.addParamate("objectType", objectType);
            req.addParamate("objectId", objectId);

            if (req.invoke()) {
                alert("权限已经被删除！");
            };


            getRolePermissions();
            
        }
    </script>

	<link href="../css/style.css" rel="stylesheet" type="text/css">
	<style type="text/css">
<!--
.TabHead2  .TabTag2 {
	width: 80px;
}
.TabHead2  .TabTag2.Act {
	width: 80px;	
}
body {
	margin-left: 0px;
	margin-top: 0px;
	margin-right: 0px;
	margin-bottom: 0px;
}
-->
	</style>
</head>
<body>
    <table border="0" cellpadding="0" cellspacing="0" class="LayoutTable">
        <tr valign="top">
            <td nowrap="nowrap" class="TdRight">
            	<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0" class="TableButtonForm">

					<tr align="center" valign="middle">
						<td height="30" align="left"> <span class="BottomBox">
							<input type="button" name="newTable" id="newTable" value="新建角色" onClick="onNewRoleClick()" />
						</span> <span class="BottomBox">
						<input type="button" name="newTable2" id="newTable2" value="保存角色" onClick="saveRole()" />
						<input type="button" name="newTable4" id="newTable4" value="添加权限" onClick="addPermission()" />
						<input type="button" name="newTable3" id="newTable3" value="保存权限" onClick="savePermission()" />
						</span></td>
					</tr>
					<tr align="center" valign="middle">
						<td height="28" align="left" class="TabHead2">
							<div class="TabTag2 Act" id="divTagRoleList">
								<div class="Left">
									<div class="Right">
										 角色列表									</div>
								</div>
							</div>
							<div class="TabTag2" id="divTagRoleInfo">
								<div class="Left">
									<div class="Right">
										角色信息									</div>
								</div>
							</div>
							<div class="TabTag2" id="divTagRolePermission">
								<div class="Left">
									<div class="Right">
										角色权限									</div>
								</div>
							</div>
						</td>
					</tr>
					<tr align="center" valign="middle">
						<td align="left" bgcolor="#FFFFFF">
							<div class="TabPageContainer">
								<div class="TabPage2 Act" id="divPageRoleList">
									<table class="ListTable" id="elRoleList" width="100%" border="0" cellspacing="0"
                            cellpadding="0">
										<tr class="ListHead" id="elRoleListHead">
											<td name="RoleId"> 角色名 </td>
											<td name="DisplayName"> 显示名称 </td>
											<td name="Remark"> 备注 </td>
											<td> </td>
										</tr>
										<tr id="elRoleItem">
											<td name="RoleId">&nbsp; </td>
											<td name="DisplayName">&nbsp; </td>
											<td name="Remark">&nbsp; </td>
											<td>
												<input type="button" name="listEditRole" value="编辑" onClick="return listEditRole_onclick(this)" />
												<input type="button" name="listDeleteRole" value="删除" onClick="return listDeleteRole_onclick(this)" />
											</td>
										</tr>
										<tr class="activeItem">
											<td name="RoleId">&nbsp; </td>
											<td name="DisplayName">&nbsp; </td>
											<td name="Remark">&nbsp; </td>
											<td>
												<input type="button" name="listEditRole" value="编辑" />
												<input type="button" name="listDeleteRole" value="删除" />
											</td>
										</tr>
									</table>
								</div>
								<div class="TabPage2" id="divPageRoleInfo">
									<table class="TableForm" width="500" border="0" cellspacing="0" cellpadding="0">
										<tr>
											<td width="80" nowrap> 角色名 </td>
											<td width="110">
												<input type="text" name="elRoleName" id="elRoleId" />
												<input type="hidden" name="elOldRoleId" id="elOldRoleId" />
											</td>
											<td width="80" nowrap> 显示名称 </td>
											<td width="110">
												<input type="text" name="elRoleName2" id="elDisplayName">
											</td>
										</tr>
										<tr>
											<td valign="top" nowrap> 说明 </td>
											<td colspan="3" rowspan="2" valign="top">
												<textarea name="elRemark" id="elRemark"></textarea>
											</td>
										</tr>
										<tr>
											<td valign="top" nowrap>&nbsp; </td>
										</tr>
										<tr>
											<td nowrap>&nbsp; </td>
											<td width="110">&nbsp; </td>
											<td nowrap>&nbsp; </td>
											<td>&nbsp; </td>
										</tr>
									</table>
								</div>
								<div class="TabPage2" id="divPageRolePermission">
									<div class="LabelList" id="elPermissionTypeList">
										<div class="LabelHead" id="elPermissionTypeListHead"> 权限类型</div>
										<div class="Label" id="elPermissionTypeItem">
											<input type="button" name="ObjectTypeTitle" value="对象类型1" onClick="onObjTypeClick(this)" />
											<input type="hidden" name="ObjectTypeId" />
										</div>
										<div class="Label ActiveLabel">
											<input type="button" name="ObjectTypeTitle" value="对象类型2" />
											<input type="hidden" name="ObjectTypeId" />
										</div>
									</div>
									<table class="ListTable" id="elPermissionList" width="100%" border="0" cellspacing="0"
                            cellpadding="0">
										<tr class="ListHead" id="elPermissionListHead">
											<td name="PermissionObjectType"> 对象类型 </td>
											<td name="PermissionObjectName"> 对象名 </td>
											<td name="Permission"> 权限 </td>
											<td> </td>
										</tr>
										<tr id="elPermissionItem">
											<td name="PermissionObjectType">&nbsp; </td>
											<td name="PermissionObjectName">&nbsp; </td>
											<td name="Permission">&nbsp; </td>
											<td>
												<input type="button" name="btnDeleteRole" value="删除" onClick="return listDeletePermission_onclick(this)" />
											</td>
										</tr>
										<tr class="activeItem">
											<td name="PermissionObjectType">&nbsp; </td>
											<td name="PermissionObjectName">&nbsp; </td>
											<td name="Permission">&nbsp; </td>
											<td>
												<input type="button" name="listEditRole" value="编辑" />
												<input type="button" name="listDeleteRole" value="删除" />
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
                <div class="TabHead01"></div>
                </td>
        </tr>
    </table>
</body>
